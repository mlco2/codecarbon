permissions:
  contents: read
name: test-package

on:
  pull_request:
    paths:
      - "codecarbon/**"
      - "pyproject.toml"
      - "uv.lock"

jobs:
  python-test:
    runs-on: ubuntu-24.04
    strategy:
        matrix:
          python-version: ["3.12", "3.13", "3.14"]
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - name: Install uv
      uses: astral-sh/setup-uv@eb1897b8dc4b5d5bfe39a428a8f2304605e0983c # v7
      with:
        version: "latest"
    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}
    - name: Install dependencies
      run: uv sync --python ${{ matrix.python-version }}
    - name: Test package
      run: uv run --python ${{ matrix.python-version }} task test-coverage
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Install carbonboard dependencies
      run: uv pip install --python ${{ matrix.python-version }} dash 'dash_bootstrap_components>1.0.0' fire
    - name: Test carbonboard visualization
      run: uv run --python ${{ matrix.python-version }} pytest -vv tests/test_viz_data.py tests/test_viz_units.py
