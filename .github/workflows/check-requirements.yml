name: Check Requirements Up-to-Date

on:
  pull_request:
    paths:
      - "pyproject.toml"
      - "requirements/requirements-api.txt"
      - ".github/workflows/check-requirements.yml"
  push:
    branches: [master]
    paths:
      - "pyproject.toml"
      - "requirements/requirements-api.txt"

permissions:
  contents: read

jobs:
  check-requirements:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    - name: Install uv
      uses: astral-sh/setup-uv@caf0cab7a618c569241d31dcd442f54681755d39 # v3.2.4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.12

    - name: Generate requirements file
      run: |
        uv pip compile pyproject.toml --extra api --output-file requirements/requirements-api-check.txt

    - name: Check if requirements file is up-to-date
      run: |
        if ! diff -u requirements/requirements-api.txt requirements/requirements-api-check.txt; then
          echo "❌ Error: requirements/requirements-api.txt is out of date!"
          echo ""
          echo "Please regenerate it by running:"
          echo "  uv pip compile pyproject.toml --extra api --output-file requirements/requirements-api.txt"
          echo ""
          echo "Then commit the updated file."
          exit 1
        else
          echo "✅ requirements/requirements-api.txt is up-to-date"
        fi
